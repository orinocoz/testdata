# MySQL replication setup (idempotent)
# Only configures replication if not already correctly set up

# Step 1: Get current replication status on all hosts
- name: Get replica status
  community.mysql.mysql_replication:
    mode: getreplica
    login_unix_socket: /var/run/mysqld/mysqld.sock
  register: replica_status
  ignore_errors: true

# Step 2: Configure source server
- name: Set read_only OFF on source
  community.mysql.mysql_variables:
    variable: read_only
    value: "OFF"
    mode: persist
    login_unix_socket: /var/run/mysqld/mysqld.sock
  when: inventory_hostname == mysql_host

- name: Stop replica on source (if running)
  community.mysql.mysql_replication:
    mode: stopreplica
    login_unix_socket: /var/run/mysqld/mysqld.sock
  when:
    - inventory_hostname == mysql_host
    - replica_status.Is_Replica is defined
    - replica_status.Is_Replica

# Step 3: Configure replica servers
- name: Set read_only ON on replica
  community.mysql.mysql_variables:
    variable: read_only
    value: "ON"
    mode: persist
    login_unix_socket: /var/run/mysqld/mysqld.sock
  when: inventory_hostname != mysql_host

- name: Stop replica before reconfiguring
  community.mysql.mysql_replication:
    mode: stopreplica
    login_unix_socket: /var/run/mysqld/mysqld.sock
  when:
    - inventory_hostname != mysql_host
    - replica_status.Source_Host is not defined or replica_status.Source_Host != mysql_host
  ignore_errors: true

- name: Configure replica to connect to source
  community.mysql.mysql_replication:
    mode: changeprimary
    login_unix_socket: /var/run/mysqld/mysqld.sock
    primary_host: "{{ mysql_host }}"
    primary_user: "{{ replica_user }}"
    primary_password: "{{ replica_password }}"
    primary_auto_position: false
  when:
    - inventory_hostname != mysql_host
    - replica_status.Source_Host is not defined or replica_status.Source_Host != mysql_host
  no_log: true

- name: Start replica on replica server
  community.mysql.mysql_replication:
    mode: startreplica
    login_unix_socket: /var/run/mysqld/mysqld.sock
  when:
    - inventory_hostname != mysql_host
    - replica_status.Replica_IO_Running is not defined or replica_status.Replica_IO_Running != "Yes"
