- name: Restart mysql
  ansible.builtin.service:
    name: mysql
    state: restarted

- name: Restart mysql exporter
  ansible.builtin.service:
    name: prometheus-mysqld-exporter
    state: restarted
    enabled: yes

- name: Restart cron
  ansible.builtin.service:
    name: cron
    state: restarted

- name: Reset MySQL source
  when: inventory_hostname in groups['db_primary']
  community.mysql.mysql_replication:
    mode: "{{ item }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
  loop:
    - stopreplica
    - resetprimary

- name: Reset MySQL replica
  when: inventory_hostname in groups['db_secondary']
  community.mysql.mysql_replication:
    mode: "{{ item }}"
    primary_host: "{{ mysql_host }}"
    primary_user: "replication"
    primary_password: "{{ mysql_replication_password | trim}}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
  loop:
    - stopreplica
    - changeprimary
    - resetreplica
    - startreplica
#
