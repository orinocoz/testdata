{% if inventory_hostname == prometheus_server %}
# Prometheus dump every day at 21:45 UTC - delete old snapshots first (as prometheus user), then create new one
45 21 * * * prometheus rm -rf /var/lib/prometheus/metrics2/snapshots/* && curl -XPOST http://localhost:9090/prometheus/api/v1/admin/tsdb/snapshot

# Full backup on Sundays at 22:50 UTC, then cleanup old backups (keep only 1 full chain)
50 22 * * 0 backup duplicity --no-encryption full /var/lib/prometheus/metrics2/snapshots/ rsync://{{ github_user_backup }}@backup.{{ startup_name }}/prometheus && duplicity remove-all-but-n-full 1 --force rsync://{{ github_user_backup }}@backup.{{ startup_name }}/prometheus

# Incremental backup Mondayâ€“Saturday at 22:50 UTC
50 22 * * 1-6 backup duplicity --no-encryption incremental /var/lib/prometheus/metrics2/snapshots/ rsync://{{ github_user_backup }}@backup.{{ startup_name }}/prometheus
{% endif %}
 
